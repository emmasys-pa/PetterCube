name: tests-and-diff-coverage

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 10 (preview)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          include-prerelease: true

      - name: Setup Python (for diff-cover)
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore

      - name: Run tests with coverage (XPlat Cobertura)
        run: |
          dotnet test \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura

      - name: Install reporting tools
        run: |
          pip install --upgrade diff-cover
          dotnet tool update -g dotnet-reportgenerator-globaltool

      - name: List coverage files (debug)
        run: |
          echo "Searching for Cobertura files..."
          find . -path "*/TestResults/*/coverage.cobertura.xml" -print || true

      - name: Generate nice HTML summary
        run: |
          reportgenerator \
            -reports:"**/TestResults/**/coverage.cobertura.xml" \
            -targetdir:coveragereport \
            -reporttypes:HtmlSummary

      - name: Enforce diff coverage
        env:
          BASE_BRANCH: ${{ github.event.pull_request.base.ref || 'main' }}
        run: |
          set -euo pipefail
          git fetch origin "$BASE_BRANCH"

          mapfile -t covfiles < <(python - <<'PY'
          import glob 
          for f in glob.glob("**/TestResults/**/coverage.cobertura.xml", recursive=True):
            print(f)
          PY
          )
          if [ ${#covfiles[@]} -eq 0 ]; then
            echo "ERROR: No coverage files (**/TestResults/**/coverage.cobertura.xml)."
            exit 1
          fi

          printf "Using coverage files:\n%s\n" "${covfiles[@]}"
          diff-cover "${covfiles[@]}" \
            --compare-branch "origin/$BASE_BRANCH" \
            --fail-under 80 \
            --format html:diff_coverage.html \
            --format markdown:diff_coverage.md

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: diff_coverage.md

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-artifacts
          path: |
            coveragereport/
            diff_coverage.html
            **/TestResults/**/coverage.cobertura.xml
