name: tests-and-diff-coverage

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write  # for å poste PR-kommentar

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # nødvendig for diff mot base-branch

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Python (for diff-cover)
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore

      - name: Run tests with coverage (Cobertura)
        run: |
          # Kjør alle testprosjekter og skriv Cobertura-xml per prosjekt.
          dotnet test \
            /p:CollectCoverage=true \
            /p:CoverletOutputFormat=cobertura \
            /p:CoverletOutput=./TestResults/coverage.xml

      - name: Install tools
        run: |
          pip install diff-cover
          dotnet tool update -g dotnet-reportgenerator-globaltool

      - name: Generate nice HTML summary (optional)
        run: |
          reportgenerator \
            -reports:**/TestResults/*.xml \
            -targetdir:coveragereport \
            -reporttypes:HtmlSummary

      - name: Enforce diff coverage (ny kode måles mot base-branch)
        env:
          BASE_BRANCH: ${{ github.event.pull_request.base.ref || 'main' }}
        run: |
          git fetch origin "$BASE_BRANCH"
          # Fail hvis < 80 % dekning på endrede linjer i PR
          diff-cover **/TestResults/*.xml \
            --compare-branch "origin/$BASE_BRANCH" \
            --fail-under 80 \
            --markdown-report diff_coverage.md \
            --html-report diff_coverage.html

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: diff_coverage.md

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-artifacts
          path: |
            coveragereport/
            diff_coverage.html
            **/TestResults/*.xml
